
    <head>
      <meta charset="UTF-8">
    </head>
    <body>
      <div>
        <canvas id="myChart"></canvas>
        <button type="button" class="btn btn-default btn-sm float" onclick="window.location.reload()">
          <span>&#8634;</span>
        </button>
      </div>
      <style>
        .float {
          position: fixed;
          top: 5px;
          left: 5px;
          background-color: rgba(0,0,0,0.25);
          padding: 5px 8px;
          color: white;
          border-radius: 6px;
          border-style: none;
          cursor: pointer;
          font-size: 1.2em;
        }
      </style>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
      function movingAverage(y, k) {
        const res = [...Array(y.length)].map(e => NaN);
        const margin = Math.floor(k/2);
        for(let i=0; i<res.length-k+1; i++) {
          res[i+margin] = y.slice(i, i+k).reduce((a, b) => a + b, 0) / k;
        }
        return (k % 2 == 0)
        ? res.map((d, i) => isNaN(d) || isNaN(res[i+1]) ? NaN: (res[i+1] + d) / 2)
        : res;
      }
      function irregularity(y, avgs) {
        return [...avgs.map((avg, i) => avg === NaN? avg: y[i]/avg)];
      }
      function seasonality(avgs, k) {
        const seasonAvg = [...Array(k)].map(d => 1);
        for(let i=0; i<k; i++) {
          const season = avgs.filter((avg, j) => j%k===i && !isNaN(avg));
          seasonAvg[i] = !season.length? 1 : season.reduce((a, b) => a + b, 0) / season.length;
        }
        let res = [];
        while(res.length + seasonAvg.length <= avgs.length) {
          res = res.concat(seasonAvg);
        }
        return res.concat(seasonAvg.slice(0, avgs.length%k));
      }
      function deseasonlize(y, seas) {
        return [...y.map((d, i) => d/seas[i])];
      }
      function forecast(y) {
        y = y.map(d => d < 0? 0: d);
        const k = 3;
        const ma = movingAverage(y, k);
        const irr = irregularity(y, ma);
        const seas = seasonality(irr, k);
        const deseas = deseasonlize(y, seas);
        const trend = linearRegression(deseas);
        const res = trend.map((d, i) => d * seas[i]);

        console.log("y: ", y);
        console.log("ma: ", ma);
        console.log("irr: ", irr);
        console.log("seas: ", seas);
        console.log("deseas: ", deseas);
        console.log("trend: ", trend);
        console.log("res: ", res);
        return res;
      }
      function forecastModeified(y) {
        const k = 3; // season length
        const trend = linearRegression(y);
        const irr = irregularity(y, trend);
        const seas = seasonality(irr, k);
        const res = trend.map((d, i) => d * seas[i]);

        console.log("y: ", y);
        console.log("trend: ", trend);
        console.log("irr: ", irr);
        console.log("seas: ", seas);
        console.log("res: ", res);
        return res;
      }
      function forecastNotion(x) {
        const season = seasons[x % seasons.length];
        console.log(season.percent * (season.a + x * season.b));
        return season.percent * (season.a + x * season.b);
      }
      function linearRegression(y) {
        const x = [...Array(y.length)].map((d, i) => i);

        const sumX = x.reduce((prev, curr) => prev + curr, 0);
        const avgX = sumX / x.length;

        const xDifferencesToAverage = x.map((value) => avgX - value);
        const xDifferencesToAverageSquared = xDifferencesToAverage.map(
          (value) => value ** 2
        );

        const SSxx = xDifferencesToAverageSquared.reduce(
          (prev, curr) => prev + curr,
          0
        );

        const sumY = y.reduce((prev, curr) => prev + curr, 0);
        const avgY = sumY / y.length;

        const yDifferencesToAverage = y.map((value) => avgY - value);

        const xAndYDifferencesMultiplied = xDifferencesToAverage.map(
          (curr, index) => curr * yDifferencesToAverage[index]
        );

          const SSxy = xAndYDifferencesMultiplied.reduce(
            (prev, curr) => prev + curr,
            0
          );

        const slope = SSxy / SSxx;
        const intercept = avgY - slope * avgX;

        const func = (f) => intercept + slope * f;
        return [...Array(y.length)].map((e, i) => func(i));
      }
          const data = [{"month":"فبراير ٢٢","amount":3479,"demand":16320,"salary":27200,"isUpcoming":false,"forecast":null},{"month":"مارس ٢٢","amount":-8020,"demand":16320,"salary":27200,"isUpcoming":false,"forecast":null},{"month":"أبريل ٢٢","amount":19966,"demand":16320,"salary":27200,"isUpcoming":false,"forecast":null},{"month":"مايو ٢٢","amount":15819,"demand":27750,"salary":46250,"isUpcoming":false,"forecast":null},{"month":"يونيه ٢٢","amount":23756.800000000003,"demand":28140.000000000004,"salary":46900.00000000001,"isUpcoming":false,"forecast":null},{"month":"يوليو ٢٢","amount":32531.60000000002,"demand":28335,"salary":47225,"isUpcoming":false,"forecast":null},{"month":"أغسطس ٢٢","amount":33584.8,"demand":28680,"salary":47800,"isUpcoming":false,"forecast":null},{"month":"سبتمبر ٢٢","amount":29158.799999999977,"demand":29400.000000000004,"salary":49000,"isUpcoming":false,"forecast":null},{"month":"أكتوبر ٢٢","amount":57018,"demand":35925,"salary":59875,"isUpcoming":false,"forecast":null},{"month":"نوفمبر ٢٢","amount":29958.5,"demand":36750,"salary":61250,"isUpcoming":false,"forecast":null},{"month":"ديسمبر ٢٢","amount":36202.25,"demand":37095,"salary":61825,"isUpcoming":false,"forecast":null},{"month":"يناير ٢٣","amount":54424.75,"demand":37110,"salary":61849.99999999999,"isUpcoming":false,"forecast":null},{"month":"فبراير ٢٣","amount":0,"demand":37110,"salary":61849.99999999999,"isUpcoming":true,"forecast":null},{"month":"مارس ٢٣","amount":0,"demand":37110,"salary":61849.99999999999,"isUpcoming":true,"forecast":null},{"month":"أبريل ٢٣","amount":0,"demand":37110,"salary":61849.99999999999,"isUpcoming":true,"forecast":null},{"month":"مايو ٢٣","amount":0,"demand":37110,"salary":61849.99999999999,"isUpcoming":true,"forecast":null},{"month":"يونيه ٢٣","amount":0,"demand":37110,"salary":61849.99999999999,"isUpcoming":true,"forecast":null},{"month":"يوليو ٢٣","amount":0,"demand":37110,"salary":61849.99999999999,"isUpcoming":true,"forecast":null}].map(d => {
				 d.percent = Math.round(10000  * (d.amount/d.salary || d.demand/d.salary))/10000; 
				 return d;
			 });
			    const seasons = [{"percent":-15.034619999999999,"a":-0.4516,"b":0.1474},{"percent":0.9368250000000001,"a":-0.4516,"b":0.1474},{"percent":1.243475,"a":-0.4516,"b":0.1474}];
          const myChart = new Chart(document.getElementById("myChart"), {
            type: "line",
            data: {
              labels: data.map(d => d.month).reverse(),
              datasets: [{
                label: "saving",
                borderColor: "rgb(57, 138, 185)",
                backgroundColor: "rgba(0, 180, 216, 0.3)",
                data: data.map((d, i) => d.isUpcoming? NaN: d.amount).reverse(),
                tension: 0.2,
                fill: true,
                borderWidth: 2,
                order: 1,
              }, {
                label: "demand",
                borderColor: "rgba(0, 230, 216, 0.3)",
                data: data.map(d => d.demand).reverse(),
                pointRadius: 0,
                borderWidth: 1,
                tooltips: { enabled: false },
                hover: { mode: null },
                backgroundColor: "rgba(255, 255, 255, 1)",
                fill: true,
                stack: "percent",
                order: 3,
              }, {
                label: "salary",
                borderColor: "rgba(0, 230, 216, 0.3)",
                data: data.map(d => d.salary - d.demand).reverse(),
                pointRadius: 0,
                borderWidth: 1,
                tooltips: { enabled: false },
                hover: { mode: null },
                backgroundColor: "rgba(0, 230, 216, 0.1)",
                fill: true,
                stack: "percent",
                order: 3,
              }, {
                label: "forecast",
                 borderColor: "rgba(245, 221, 144, 0.6)",
                data: forecastModeified(data.map(d => d.percent)).map((d, i) => d * data[i].salary).reverse(),
                pointRadius: 0,
                 borderWidth: 2,
                 tension: 0.2,
                 borderDash: [6, 4],
                 tooltips: { enabled: false },
                 hover: { mode: null },
                 order: 2
              }, {
                 label: "forecastNotion",
                 hidden: true,
                 borderColor: "rgba(245, 221, 144, 0.6)",
                 data: data.map((d, i) => forecastNotion(i)).map((d, i) => d * data[i].salary).reverse(),
                 pointRadius: 0,
                 borderWidth: 2,
                 tension: 0.2,
                 borderDash: [6, 4],
                 tooltips: { enabled: false },
                 hover: { mode: null },
                 order: 2
               }]
            },
            options: {
              plugins: {
                legend: {
                  display: false,
                  position: "left",
                  rtl: true
                },
                title: {
                  display: true,
                  position: "top",
                  text: ["مدخرات العام"]
                }
              },
              tooltips: {
                rtl: true
              },
              aspectRatio: 3,
              scales: {
                 y: {
                  type: "linear",
                  display: true,
                  position: "right",
                  min: 0,
                  ticks: {
                    stepSize: 10000
                  },
                  grid: {
                    z: 1,
                    color: "rgba(0, 0, 0, 0.1)"
                  }
                 },
                 x: {
                  grid: {
                    z: 1,
                    color: "rgba(0, 0, 0, 0.01)"
                  }
                 }
               }
            }
          });
      </script>
    </body>

